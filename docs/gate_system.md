# Gate System

This document outlines the experimental gate and instance system currently under development. Gates represent temporary portals that lead to instanced encounter areas. The code can be found in `src/gate.h` and `src/gatemanager.*`.

## Enumerations

### `GateRank`

| Value | Description | Typical Duration |
|-------|-------------|------------------|
| `E`   | Lowest rank. Used for entry level encounters. | ~10 minutes |
| `D`   | Slightly harder challenge. | ~20 minutes |
| `C`   | Moderate difficulty. | ~30 minutes |
| `B`   | High difficulty. | ~40 minutes |
| `A`   | Very high difficulty. | ~50 minutes |
| `S`   | Highest rank reserved for end‑game content. | ~60 minutes |

The rank also determines how long the gate persists before breaking if it is not cleared.

### `GateType`

| Value   | Description |
|---------|-------------|
| `NORMAL`| Standard gate with one instance. |
| `RED`   | More dangerous variant that may spawn tougher enemies. |
| `DOUBLE`| Creates two linked instances for large groups. |

## `Gate` Class

Each `Gate` object tracks the portal state and its associated instance.

- **ID** – Unique identifier generated by `GateManager`.
- **Position** – Where the gate exists in the world.
- **Creation and Expiration Timestamps** – Millisecond timestamps used to check when the gate should break.
- **Rank and Type** – Enumerations described above.
- **Instance Pointer** – Optional pointer to the dungeon instance that players enter.
- **Status Flags** – `bossDefeated`, `expired` and `cleared` are booleans tracking progress.

## `GateManager` Usage

`GateManager` owns all active gates and must be updated regularly.

- `spawnGate(position, rank, type)` – Creates a gate at `position` with the given rank and type. The expiration time is derived from the rank.
- `update()` – Should be called every server tick or on a timed event. It marks gates as expired when their timer elapses and removes them from the manager. When a gate breaks before being cleared it triggers the optional `onGateBreak` Lua hook and spawns monsters configured in `GateBreakWaves`.
- `getGate(id)` – Returns a pointer to the stored `Gate` or `nullptr` if the ID is unknown.
- `removeGate(id)` – Erases a gate immediately from the manager.

### Integration Notes

The server now calls `GateManager::update()` every tick from the main game loop, so gates expire automatically. You can control gates from Lua using:

1. `Game.spawnGate(position, rank[, type])` – returns the created gate id.
2. `Game.removeGate(id)` – immediately deletes the gate.

Still provide an `onGateBreak(gate)` function inside `data/scripts/gate/` if you want custom logic when a gate shatters. Use the `GateBreakWaves` table to list which monsters should spawn for each rank. The `Instance` class and dungeon logic are still experimental and need to be fleshed out.

### Lua Hook Example

Create a file at `data/scripts/gate/gate_break.lua`:

```lua
GateBreakWaves = {
    E = { {name = "rat", count = 2} },
    D = { {name = "orc", count = 3} }
}

function onGateBreak(gate)
    print("Gate broke at", gate.position.x, gate.position.y, gate.position.z)
end
```

`GateBreakWaves` defines the monsters spawned when a gate of the given rank collapses. The `onGateBreak` function is optional and can be extended to implement additional behavior.

